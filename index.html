<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Arena 2D Online</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#111;font-family:Arial;overflow:hidden;color:#fff;}
canvas{background:#222;display:block;}
#menu{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;gap:20px;}
#menu h1{font-size:3em;color:#0ff;}
input,button{padding:15px 35px;font-size:1.4em;border-radius:12px;border:none;cursor:pointer;}
button{background:#00ff88;color:#000;font-weight:bold;}
button:hover{background:#00cc66;}
#roomCode{font-size:3.5em;font-weight:bold;color:#0ff;letter-spacing:15px;}
#status{font-size:1.4em;color:#ffcc00;}
#hud{position:absolute;top:10px;left:10px;right:10px;z-index:10;display:flex;justify-content:space-between;align-items:center;pointer-events:none;display:none;}
.player-info{background:rgba(0,0,0,0.8);padding:15px;border-radius:10px;min-width:250px;}
.health-bar{width:180px;height:22px;background:#333;border:2px solid #fff;margin:10px 0;overflow:hidden;border-radius:10px;}
.health{height:100%;background:linear-gradient(#0f0,#4f0);transition:width 0.3s;}
#shop-btn{background:#00ccff;padding:16px 32px;border-radius:12px;font-weight:bold;cursor:pointer;pointer-events:all;font-size:1.1em;}
#shop-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;justify-content:center;align-items:center;z-index:100;}
#shop{background:#222;padding:40px;border-radius:20px;border:4px solid #0ff;max-width:550px;text-align:center;}
#player-coins{color:gold;font-size:1.3em;margin:15px 0;}
.weapon{background:#333;margin:25px 0;padding:25px;border-radius:15px;cursor:pointer;transition:0.3s;}
.weapon:hover{background:#444;transform:scale(1.03);}
.price{font-weight:bold;font-size:1.4em;}
button{margin-top:25px;padding:15px 35px;font-size:1.2em;background:#00ff88;border-radius:10px;cursor:pointer;}
</style>
</head>
<body>
<div id="menu">
  <h1>üèüÔ∏è ARENA 2D ONLINE</h1>
  <button id="createBtn">Criar Sala</button>
  <div style="display:flex;gap:15px;">
    <input id="codeInput" placeholder="C√ìDIGO DE 5 LETRAS" maxlength="5" style="text-transform:uppercase;width:220px;text-align:center;font-size:1.6em;">
    <button id="joinBtn">Entrar na Sala</button>
  </div>
  <div id="roomCode"></div>
  <div id="status">Carregando...</div>
</div>

<canvas id="c"></canvas>

<div id="hud">
  <div class="player-info">
    <div>Voc√™: WASD + ESPA√áO (tiro) + C (dash)</div>
    <div class="health-bar"><div id="hLocal" class="health" style="width:100%"></div></div>
    <div id="cLocal">0 moedas</div>
  </div>
  <div id="shop-btn">LOJA (F)</div>
  <div class="player-info">
    <div>Oponente</div>
    <div class="health-bar"><div id="hRemote" class="health" style="width:100%"></div></div>
    <div id="cRemote">0 moedas</div>
  </div>
</div>

<div id="shop-overlay">
  <div id="shop">
    <h2 id="shop-title">LOJA</h2>
    <div id="player-coins"></div>
    <p>1,2,3,4 = comprar/selecionar | ESC = fechar</p>
    <div class="weapon" data-w="pistol">
      <h3>1 ‚Üí Pistola</h3><p>Dano 20 ‚Ä¢ Cad√™ncia normal</p><span class="price">Gr√°tis</span>
    </div>
    <div class="weapon" data-w="shotgun">
      <h3>2 ‚Üí Escopeta</h3><p>5 tiros ‚Ä¢ Dano total 40</p><span class="price">150 moedas</span>
    </div>
    <div class="weapon" data-w="machinegun">
      <h3>3 ‚Üí Metralhadora</h3><p>Dano 6 ‚Ä¢ Cad√™ncia alt√≠ssima</p><span class="price">300 moedas</span>
    </div>
    <div class="weapon" data-w="espada">
      <h3>4 ‚Üí Espada Laser</h3><p>Giro + Dash (5s CD)</p><span class="price">100 moedas</span>
    </div>
    <button onclick="closeShop()">Fechar</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let isP1 = false, gameStarted = false, localKeys = {}, opponentKeys = {}, lastSync = 0;
let p1, p2, localPlayer, remotePlayer, bullets = [], effects = [], keys = {}, gameOver = false, gameState = 'menu', startTime = 0;
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = innerWidth; canvas.height = innerHeight; if (p2) p2.x = canvas.width - 150; }
resize(); window.addEventListener('resize', resize);

// Save local (p1 ou p2 dependendo de quem √©)
let saveStr = localStorage.getItem('arena2d') || '{"p1":{"coins":0,"weapon":"pistol","owned":["pistol"]},"p2":{"coins":0,"weapon":"pistol","owned":["pistol"]}}';
let save = JSON.parse(saveStr);
['p1','p2'].forEach(id => { if (!save[id]) save[id] = {coins:0, weapon:'pistol', owned:['pistol']}; if (!save[id].owned) save[id].owned = ['pistol']; });
localStorage.setItem('arena2d', JSON.stringify(save));

// Armas 100%
const weapons = {
  pistol: {dmg:20, cd:20, speed:12, color:'#fff', fire:p=>bullets.push(bullet(p,0))},
  shotgun: {dmg:8, cd:40, speed:10, color:'#ff8800', fire:p=>[-0.25,-0.12,0,0.12,0.25].forEach(a=>bullets.push(bullet(p,a)))},
  machinegun: {dmg:6, cd:5, speed:14, color:'#00ffff', fire:p=>bullets.push(bullet(p,(Math.random()-0.5)*0.25))},
  espada: {dmg:40, cd:30, speed:0, color:'#ff00ff', fire:p=>{
    effects.push({x:p.x,y:p.y,life:25,angle:0, owner:p.id});
    const other = p.id==='p1'?p2:p1;
    if (Math.hypot(p.x-other.x,p.y-other.y)<60) other.health -=40;
  }}
};
function bullet(p,spread=0) {
  const w = weapons[p.weapon], a = p.angle + spread;
  return {x:p.x+Math.cos(a)*45, y:p.y+Math.sin(a)*45, vx:Math.cos(a)*w.speed, vy:Math.sin(a)*w.speed, color:w.color, dmg:w.dmg, owner:p.id};
}

// Player class modificada (update recebe keys)
class Player {
  constructor(x,color,controls,id) {
    this.x = x; this.y = canvas.height/2; this.color = color; this.controls = controls; this.id = id;
    this.health = 100; this.weapon = save[id].weapon; this.coins = save[id].coins;
    this.angle = 0; this.cd = 0; this.dashCd = 0;
  }
  update(inputKeys) {
    if (inputKeys[this.controls.up]) this.y -=5;
    if (inputKeys[this.controls.down]) this.y +=5;
    if (inputKeys[this.controls.left]) this.x -=5;
    if (inputKeys[this.controls.right]) this.x +=5;
    this.x = Math.max(30,Math.min(canvas.width-30,this.x));
    this.y = Math.max(30,Math.min(canvas.height-30,this.y));
    const target = this.id==='p1'?p2:p1;
    this.angle = Math.atan2(target.y-this.y, target.x-this.x);
    if (this.cd > 0) this.cd--;
    if (this.dashCd > 0) this.dashCd--;
    if (inputKeys[this.controls.shoot] && this.cd <= 0) {
      weapons[this.weapon].fire(this);
      this.cd = weapons[this.weapon].cd;
    }
  }
  draw() {
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.angle);
    ctx.fillStyle = this.color; ctx.fillRect(-20,-20,40,40);
    ctx.fillStyle = '#333'; ctx.fillRect(15,-8,30,16); ctx.restore();
    ctx.fillStyle = 'white'; ctx.font = '12px Arial'; ctx.fillText(this.weapon.toUpperCase(), this.x-40, this.y-30);
  }
}

// Menu
document.getElementById('createBtn').onclick = () => socket.emit('createRoom');
document.getElementById('joinBtn').onclick = () => {
  const code = document.getElementById('codeInput').value.toUpperCase().trim();
  if (code.length !== 5) return alert('Digite 5 letras/n√∫meros!');
  socket.emit('joinRoom', code);
};
document.getElementById('codeInput').oninput = e => e.target.value = e.target.value.toUpperCase();

socket.on('roomCreated', code => {
  document.getElementById('roomCode').textContent = code;
  document.getElementById('status').textContent = 'Compartilhe este c√≥digo!';
});
socket.on('startGame', data => {
  isP1 = data.p1Id === socket.id;
});
socket.on('startCountdown', () => {
  gameStarted = true;
  document.getElementById('menu').style.display = 'none';
  document.getElementById('hud').style.display = 'flex';
  p1 = new Player(150, '#00ff00', {up:'w',down:'s',left:'a',right:'d',shoot:' '}, 'p1');
  p2 = new Player(canvas.width-150, '#ff0066', {up:'ArrowUp',down:'ArrowDown',left:'ArrowLeft',right:'ArrowRight',shoot:'Enter'}, 'p2');
  localPlayer = isP1 ? p1 : p2;
  remotePlayer = isP1 ? p2 : p1;
  reset();
  loop();
});
socket.on('error', msg => alert(msg));
socket.on('opponentLeft', () => { alert('Oponente saiu!'); location.reload(); });

// Controles locais
const dashKey = isP1 ? 'c' : 'l'; // N√£o funciona aqui, set din√¢mico
const shopKey = isP1 ? 'f' : 'g';
onkeydown = e => {
  e.preventDefault();
  const key = e.key.toLowerCase();
  localKeys[key] = true; localKeys[e.key] = true;
  if (gameStarted && gameState === 'playing' && !shopOpen) {
    if (key === (isP1 ? 'c' : 'l') && localPlayer.weapon === 'espada' && localPlayer.dashCd <= 0) doDash(localPlayer);
  }
  if (key === (isP1 ? 'f' : 'g')) openShop(localPlayer.id);
  if (e.key === 'Escape') closeShop();
  if (shopOpen && '1234'.includes(e.key)) buy(e.key);
};
onkeyup = e => {
  localKeys[e.key.toLowerCase()] = false; localKeys[e.key] = false;
};

// Recebe estado oponente
socket.on('opponentState', data => {
  remotePlayer.x = data.x; remotePlayer.y = data.y; remotePlayer.angle = data.angle;
  remotePlayer.health = data.health; remotePlayer.weapon = data.weapon; remotePlayer.coins = data.coins;
  remotePlayer.cd = data.cd; remotePlayer.dashCd = data.dashCd;
  // Sync balas oponente
  bullets = bullets.filter(b => b.owner === localPlayer.id);
  data.bullets.forEach(bdata => bullets.push({...bdata, owner: remotePlayer.id}));
  // Sync efeitos oponente
  effects = effects.filter(e => e.owner === localPlayer.id);
  data.effects.forEach(edata => effects.push({...edata}));
});

// Envia estado local (throttle 30ms)
function enviarEstado() {
  const now = Date.now();
  if (now - lastSync < 30 || !gameStarted) return;
  lastSync = now;
  socket.emit('playerState', {
    x: localPlayer.x, y: localPlayer.y, angle: localPlayer.angle,
    health: localPlayer.health, weapon: localPlayer.weapon, coins: localPlayer.coins,
    cd: localPlayer.cd, dashCd: localPlayer.dashCd,
    bullets: bullets.filter(b => b.owner === localPlayer.id).map(b => ({x:b.x,y:b.y,vx:b.vx,vy:b.vy,color:b.color,dmg:b.dmg})),
    effects: effects.filter(e => e.owner === localPlayer.id).map(e => ({x:e.x,y:e.y,life:e.life,angle:e.angle}))
  });
}

// Dash
function doDash(player) {
  const dist = 200;
  player.x += Math.cos(player.angle) * dist;
  player.y += Math.sin(player.angle) * dist;
  player.x = Math.max(30, Math.min(canvas.width-30, player.x));
  player.y = Math.max(30, Math.min(canvas.height-30, player.y));
  weapons.espada.fire(player);
  player.dashCd = 300;
}

// Loja 100% original (adaptada local)
let shopOpen = false;
const overlay = document.getElementById('shop-overlay'), shopTitleEl = document.getElementById('shop-title'), coinsEl = document.getElementById('player-coins');
function openShop(id) {
  if (gameState !== 'playing' || shopOpen) return;
  shopOpen = true;
  shopTitleEl.textContent = `LOJA DO ${id.toUpperCase()}`;
  const player = id === 'p1' ? p1 : p2;
  coinsEl.textContent = `${player.coins} moedas`;
  overlay.style.display = 'flex';
  updateShopUI(id);
}
function closeShop() {
  shopOpen = false;
  overlay.style.display = 'none';
}
function updateShopUI(id) {
  const player = id === 'p1' ? p1 : p2, prices = {pistol:0,shotgun:150,machinegun:300,espada:100};
  document.querySelectorAll('.weapon').forEach(el => {
    const w = el.dataset.w, priceSpan = el.querySelector('.price');
    if (player.weapon === w) { priceSpan.textContent = 'EQUIPADO ‚úì'; priceSpan.style.color = '#0f0'; }
    else if (save[id].owned.includes(w)) { priceSpan.textContent = 'SELECIONAR'; priceSpan.style.color = '#0ff'; }
    else { priceSpan.textContent = `${prices[w]} moedas`; priceSpan.style.color = 'gold'; }
  });
}
function buy(num) {
  const id = localPlayer.id, player = localPlayer, map = {'1':'pistol','2':'shotgun','3':'machinegun','4':'espada'}, prices = {pistol:0,shotgun:150,machinegun:300,espada:100}, w = map[num];
  if (save[id].owned.includes(w)) { player.weapon = w; save[id].weapon = w; }
  else {
    const price = prices[w];
    if (player.coins < price) return;
    player.coins -= price; save[id].coins = player.coins; save[id].owned.push(w);
    player.weapon = w; save[id].weapon = w;
  }
  localStorage.setItem('arena2d', JSON.stringify(save));
  coinsEl.textContent = `${player.coins} moedas`;
  updateShopUI(id);
  updateHUD();
}

// HUD
function updateHUD() {
  document.getElementById('hLocal').style.width = `${localPlayer.health}%`;
  document.getElementById('hRemote').style.width = `${remotePlayer.health}%`;
  document.getElementById('cLocal').textContent = `${localPlayer.coins} moedas`;
  document.getElementById('cRemote').textContent = `${remotePlayer.coins} moedas`;
}

// Reset
function reset() {
  p1.health = p2.health = 100; p1.dashCd = p2.dashCd = 0;
  p1.x = 150; p2.x = canvas.width - 150; p1.y = p2.y = canvas.height / 2;
  bullets = []; effects = []; gameOver = false; gameState = 'countdown'; startTime = Date.now() + 3000;
}

// Loop principal 100%
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const now = Date.now();
  if (gameState === 'countdown') {
    let timeLeft = (startTime - now) / 1000;
    if (timeLeft <= 0) { gameState = 'playing'; }
    else {
      ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'white'; ctx.font = 'bold 250px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(Math.ceil(timeLeft), canvas.width/2, canvas.height/2);
      ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';
    }
  } else if (!gameOver && gameStarted) {
    // Update players com keys corretas
    p1.update(isP1 ? localKeys : opponentKeys);
    p2.update(isP1 ? opponentKeys : localKeys);

    p1.draw(); p2.draw();

    // Efeitos espada
    for (let i = effects.length - 1; i >= 0; i--) {
      let e = effects[i]; e.life--; if (e.life <= 0) { effects.splice(i, 1); continue; }
      e.angle += 0.4;
      ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(e.angle);
      ctx.strokeStyle = `hsla(300,100%,60%,${e.life/25})`; ctx.lineWidth = 10 * (e.life / 25); ctx.lineCap = 'round';
      ctx.beginPath(); ctx.arc(0, 0, 45, 0, Math.PI * 2); ctx.stroke(); ctx.restore();
    }

    // Dash UI
    [p1, p2].forEach((player, idx) => {
      if (player.weapon !== 'espada') return;
      const prog = Math.max(0, player.dashCd / 300), sx = idx === 0 ? 20 : canvas.width - 55, sy = canvas.height - 80, w = 35, h = 35;
      ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(sx, sy, w, h);
      ctx.strokeStyle = '#ff00ff'; ctx.lineWidth = 2; ctx.strokeRect(sx, sy, w, h);
      ctx.fillStyle = '#ff00ff'; ctx.fillRect(sx + 2, sy + h - prog * h - 2, w - 4, prog * h);
      if (prog === 0) { ctx.fillStyle = '#00ff00'; ctx.fillRect(sx + 2, sy + h - 5, w - 4, 5); }
    });

    // Balas
    for (let i = bullets.length - 1; i >= 0; i--) {
      const b = bullets[i]; b.x += b.vx; b.y += b.vy;
      if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) { bullets.splice(i, 1); continue; }
      ctx.fillStyle = b.color; ctx.fillRect(b.x - 4, b.y - 4, 8, 8);
      if (Math.hypot(b.x - p1.x, b.y - p1.y) < 28 && b.owner !== 'p1') { p1.health -= b.dmg; bullets.splice(i, 1); }
      else if (Math.hypot(b.x - p2.x, b.y - p2.y) < 28 && b.owner !== 'p2') { p2.health -= b.dmg; bullets.splice(i, 1); }
    }

    // Vit√≥ria
    if (p1.health <= 0 || p2.health <= 0) {
      gameOver = true;
      const winner = p1.health > 0 ? p1 : p2;
      winner.coins += 100;
      save[winner.id].coins = winner.coins;
      localStorage.setItem('arena2d', JSON.stringify(save));
      setTimeout(() => {
        alert(`${winner.id === localPlayer.id ? 'VOC√ä VENCEU!' : 'VOC√ä PERDEU!'} +100 moedas pro vencedor`);
        reset();
      }, 500);
    }

    enviarEstado();
  }
  updateHUD();
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
